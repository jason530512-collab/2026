<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>æˆ‘çš„å¿ƒæƒ…æ¡Œå¸ƒæœˆæ›†</title>

<script src="https://unpkg.com/solarlunar/lib/solarlunar.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<style>
:root { --photo-height: 360px; }
body { margin: 0; background: #f3c6c6; font-family: -apple-system, "Helvetica Neue", Helvetica, Arial, "PingFang TC", sans-serif; display: flex; flex-direction: column; align-items: center; padding: 16px; }

.calendar { width: 100%; max-width: 380px; background: #000; border-radius: 26px; overflow: hidden; color: #fff; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }

.photo { height: var(--photo-height); background: #111 center / cover no-repeat; position: relative; cursor: pointer; }
.photo input { position: absolute; inset: 0; opacity: 0; z-index: 5; width: 100%; height: 100%; cursor: pointer; }
.photoHint { position: absolute; bottom: 10px; right: 12px; font-size: 12px; background: rgba(0,0,0,0.6); padding: 4px 8px; border-radius: 8px; pointer-events: none; }

.greeting { text-align: center; padding: 12px; font-size: 15px; background: #7f3fbf; min-height: 1.5em; color: #fff; outline: none; }

.monthNav { display: flex; justify-content: space-between; align-items: center; padding: 15px 20px; }
.monthNav button { font-size: 18px; padding: 8px 16px; border-radius: 12px; border: none; background: #ffd966; color: #000; font-weight: bold; -webkit-appearance: none; }
#monthLabel { font-size: 1.2rem; font-weight: bold; }

.weekdays, .days { display: grid; grid-template-columns: repeat(7, 1fr); text-align: center; }
.weekdays div { opacity: 0.6; font-size: 13px; padding-bottom: 8px; }

.days { position: relative; padding-bottom: 15px; min-height: 250px; }
/* ä¿®æ­£èƒŒæ™¯åœ–é€æ˜åº¦å•é¡Œ */
.days-bg { position: absolute; inset: 0; background: url("horse.jpg") center / contain no-repeat; opacity: 0.25; pointer-events: none; }

.day-cell { position: relative; padding: 8px 0; display: flex; flex-direction: column; align-items: center; z-index: 2; min-height: 50px; }
.solar-date { font-size: 17px; font-weight: 500; }
.lunar-date { font-size: 10px; opacity: 0.8; margin-top: 2px; }

.weekend .solar-date { color: #ff4d4f; }
.holiday { background: rgba(107, 193, 255, 0.3); border-radius: 10px; }
.holiday .solar-date { color: #6bc1ff; }

.btn { margin: 20px 0; padding: 14px 40px; border-radius: 14px; background: #ffd966; color: #000; text-align: center; font-weight: bold; cursor: pointer; width: 85%; max-width: 320px; }

/* çµæœé¡¯ç¤ºå±¤ */
#resultMask { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 9999; }
#resultImage { max-width: 85%; max-height: 70%; border-radius: 10px; border: 1px solid #fff; }
#resultMask p { color: #ffd966; margin-top: 15px; }

.hide-ui .btn, .hide-ui .photoHint, .hide-ui .monthNav button { visibility: hidden !important; }
</style>
</head>

<body>

<div class="calendar" id="calendar">
  <div class="photo" id="photoArea">
    <input type="file" id="photoInput" accept="image/*">
    <span class="photoHint">ğŸ“· é»æ“Šæ›´æ›ç…§ç‰‡</span>
  </div>
  
  <div class="greeting" contenteditable="true">å¯«ä¸‹æ‚¨çš„å¿ƒæƒ…...</div>
  
  <div class="monthNav">
    <button id="prevBtn">â—€</button>
    <div id="monthLabel"></div>
    <button id="nextBtn">â–¶</button>
  </div>

  <div class="weekdays">
    <div>æ—¥</div><div>ä¸€</div><div>äºŒ</div><div>ä¸‰</div><div>å››</div><div>äº”</div><div>å…­</div>
  </div>

  <div class="days" id="daysContainer">
      <div class="days-bg"></div>
      </div>
</div>

<div class="btn" id="saveBtn">ğŸ“¸ ç”Ÿæˆæ‰‹æ©Ÿå„²å­˜åœ–ç‰‡</div>

<div id="resultMask">
  <img id="resultImage" src="" alt="">
  <p>ğŸ’¡ é•·æŒ‰åœ–ç‰‡ã€Œå„²å­˜åˆ°ç›¸ç°¿ã€</p>
  <div class="btn" style="background:#555; color:#fff;" onclick="document.getElementById('resultMask').style.display='none'">è¿”å›ä¿®æ”¹</div>
</div>

<script>
// ç¢ºä¿ DOM åŠ è¼‰å®Œç•¢
window.onload = function() {
    let currentData = new Date();
    const holidays = {"1-1":"å…ƒæ—¦","2-28":"å’Œå¹³ç´€å¿µæ—¥","4-4":"å…’ç«¥ç¯€","4-5":"æ¸…æ˜ç¯€","10-10":"åœ‹æ…¶æ—¥"};

    function render() {
        const y = currentData.getFullYear();
        const m = currentData.getMonth();
        const daysContainer = document.getElementById("daysContainer");
        
        // ä¿ç•™èƒŒæ™¯åœ–ï¼Œæ¸…ç©ºèˆŠæ—¥æœŸ
        const bg = daysContainer.querySelector('.days-bg');
        daysContainer.innerHTML = '';
        daysContainer.appendChild(bg);

        document.getElementById("monthLabel").innerText = y + " å¹´ " + (m + 1) + " æœˆ";

        const firstDay = new Date(y, m, 1).getDay();
        const totalDays = new Date(y, m + 1, 0).getDate();

        for(let i=0; i<firstDay; i++) {
            daysContainer.appendChild(document.createElement("div"));
        }

        for(let d=1; d<=totalDays; d++){
            const cell = document.createElement("div");
            cell.className = "day-cell";
            
            const solarSpan = document.createElement("span");
            solarSpan.className = "solar-date";
            solarSpan.innerText = d;
            
            // è¾²æ›†è™•ç† (ä½¿ç”¨ solarLunar åº«)
            let lunarText = "";
            try {
                // æ³¨æ„ï¼šåº«çš„åå­—é€šå¸¸æ˜¯ solarLunar
                const lunarInfo = solarLunar.solar2lunar(y, m + 1, d);
                lunarText = lunarInfo.term || (lunarInfo.lDay === 1 ? lunarInfo.monthCn : lunarInfo.dayCn);
            } catch(e) {
                lunarText = "";
            }

            const lunarSpan = document.createElement("span");
            lunarSpan.className = "lunar-date";
            lunarSpan.innerText = lunarText;

            const dayOfWeek = new Date(y, m, d).getDay();
            if(dayOfWeek === 0 || dayOfWeek === 6) cell.classList.add("weekend");
            if(holidays[(m+1)+"-"+d]) cell.classList.add("holiday");

            cell.appendChild(solarSpan);
            cell.appendChild(lunarSpan);
            daysContainer.appendChild(cell);
        }
    }

    render();

    document.getElementById('prevBtn').onclick = function() { currentData.setMonth(currentData.getMonth()-1); render(); };
    document.getElementById('nextBtn').onclick = function() { currentData.setMonth(currentData.getMonth()+1); render(); };

    document.getElementById('photoInput').onchange = function(e) {
        const file = e.target.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = function(event) {
            document.getElementById('photoArea').style.backgroundImage = "url(" + event.target.result + ")";
            try { localStorage.setItem("cal_img", event.target.result); } catch(err) {}
        };
        reader.readAsDataURL(file);
    };

    const cached = localStorage.getItem("cal_img");
    if(cached) document.getElementById('photoArea').style.backgroundImage = "url(" + cached + ")";

    document.getElementById('saveBtn').onclick = async function() {
        const btn = this;
        btn.innerText = "è™•ç†ä¸­...";
        const calendar = document.getElementById("calendar");
        
        calendar.classList.add("hide-ui");
        
        // çµ¦ Safari ä¸€é»ç·©è¡æ™‚é–“
        await new Promise(res => setTimeout(res, 300));

        html2canvas(calendar, {
            useCORS: true,
            scale: window.devicePixelRatio || 2,
            backgroundColor: "#000",
            allowTaint: true
        }).then(canvas => {
            const imgData = canvas.toDataURL("image/png");
            const resImg = document.getElementById("resultImage");
            resImg.src = imgData;
            document.getElementById("resultMask").style.display = "flex";
            calendar.classList.remove("hide-ui");
            btn.innerText = "ğŸ“¸ ç”Ÿæˆæ‰‹æ©Ÿå„²å­˜åœ–ç‰‡";
        }).catch(err => {
            alert("æˆªåœ–å¤±æ•—ï¼Œå»ºè­°ä½¿ç”¨æ‰‹æ©Ÿå…§å»ºæˆªåœ–");
            calendar.classList.remove("hide-ui");
            btn.innerText = "ğŸ“¸ ç”Ÿæˆæ‰‹æ©Ÿå„²å­˜åœ–ç‰‡";
        });
    };
};
</script>

</body>
</html>
