<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>æˆ‘çš„å¿ƒæƒ…æ¡Œå¸ƒæœˆæ›† (å«è¾²æ›†)</title>

<script src="https://cdn.jsdelivr.net/npm/solar-lunar@1.1.5/lib/solar-lunar.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<style>
:root { --photo-height: 360px; }
body { margin: 0; background: #f3c6c6; font-family: -apple-system, BlinkMacSystemFont, "PingFang TC", sans-serif; display: flex; flex-direction: column; align-items: center; padding: 16px; }

.calendar { width: 100%; max-width: 380px; background: #000; border-radius: 26px; overflow: hidden; color: #fff; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }

/* ç…§ç‰‡å€åŸŸ */
.photo { height: var(--photo-height); background: #111 center / cover no-repeat; position: relative; cursor: pointer; }
.photo input { position: absolute; inset: 0; opacity: 0; z-index: 2; cursor: pointer; }
.photoHint { position: absolute; bottom: 10px; right: 12px; font-size: 12px; background: rgba(0,0,0,0.6); padding: 4px 8px; border-radius: 8px; pointer-events: none; }

.greeting { text-align: center; padding: 12px; font-size: 15px; background: #7f3fbf; min-height: 1.5em; color: #fff; }
.greeting[contenteditable] { outline: none; border-bottom: 1px dashed rgba(255,255,255,0.3); }

.monthNav { display: flex; justify-content: space-between; align-items: center; padding: 15px 20px; }
.monthNav button { font-size: 18px; padding: 8px 16px; border-radius: 12px; border: none; background: #ffd966; color: #000; font-weight: bold; }
#monthLabel { font-size: 1.2rem; font-weight: bold; letter-spacing: 1px; }

.weekdays, .days { display: grid; grid-template-columns: repeat(7, 1fr); text-align: center; }
.weekdays div { opacity: 0.6; font-size: 13px; padding-bottom: 8px; }

.days { position: relative; padding-bottom: 15px; min-height: 250px; }
.days::before { content: ""; position: absolute; inset: 0; background: url("horse.jpg") center / contain no-repeat; opacity: 0.25; pointer-events: none; }

/* æ—¥æœŸæ ¼å­æ’ç‰ˆ */
.day-cell { position: relative; padding: 8px 0; display: flex; flex-direction: column; align-items: center; z-index: 1; min-height: 50px; }
.solar-date { font-size: 17px; font-weight: 500; }
.lunar-date { font-size: 10px; opacity: 0.8; margin-top: 2px; transform: scale(0.9); }

.weekend .solar-date { color: #ff4d4f; font-weight: bold; }
.holiday { background: rgba(107, 193, 255, 0.3); border-radius: 10px; }
.holiday .solar-date { color: #6bc1ff; }

.btn { margin: 20px 0; padding: 14px 40px; border-radius: 14px; background: #ffd966; color: #000; text-align: center; font-weight: bold; cursor: pointer; width: 85%; max-width: 320px; transition: 0.2s; }
.btn:active { transform: scale(0.98); opacity: 0.9; }

/* æˆªåœ–é®ç½©å±¤ */
#resultMask { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 1000; }
#resultImage { max-width: 85%; max-height: 75%; border-radius: 15px; border: 2px solid #555; }
#resultMask p { color: #ffd966; margin-top: 20px; font-size: 15px; font-weight: bold; text-shadow: 0 0 10px rgba(0,0,0,1); }

/* æˆªåœ–æ™‚éš±è—æŒ‰éˆ•èˆ‡æç¤º */
.hide-ui .btn, .hide-ui .photoHint, .hide-ui .monthNav button { display: none !important; }
</style>
</head>

<body>

<div class="calendar" id="calendar">
  <div class="photo" id="photoArea">
    <input type="file" id="photoInput" accept="image/*">
    <span class="photoHint">ğŸ“· é»æ“Šæ›´æ›æ¡Œå¸ƒç›¸ç‰‡</span>
  </div>
  
  <div class="greeting" contenteditable="true">å¯«ä¸‹é€™å€‹æœˆçš„å¿ƒæƒ…... âœ¨</div>
  
  <div class="monthNav">
    <button id="prev">â—€</button>
    <div id="monthLabel"></div>
    <button id="next">â–¶</button>
  </div>

  <div class="weekdays">
    <div>æ—¥</div><div>ä¸€</div><div>äºŒ</div><div>ä¸‰</div><div>å››</div><div>äº”</div><div>å…­</div>
  </div>

  <div class="days" id="days"></div>
</div>

<div class="btn" id="saveImage">ğŸ“¸ ç”Ÿæˆæ‰‹æ©Ÿå„²å­˜åœ–ç‰‡</div>

<div id="resultMask">
  <img id="resultImage" src="" alt="ç”Ÿæˆçš„æœˆæ›†">
  <p>ğŸ’¡ é•·æŒ‰åœ–ç‰‡ã€Œå„²å­˜åˆ°ç›¸ç°¿ã€</p>
  <div class="btn" style="background: #444; color: white; margin-top: 10px;" onclick="document.getElementById('resultMask').style.display='none'">è¿”å›ä¿®æ”¹</div>
</div>

<script>
let date = new Date();
const holidays = {"1-1":"å…ƒæ—¦","2-28":"å’Œå¹³ç´€å¿µæ—¥","4-4":"å…’ç«¥ç¯€","4-5":"æ¸…æ˜ç¯€","10-10":"åœ‹æ…¶æ—¥"};

function render() {
  const y = date.getFullYear();
  const m = date.getMonth();
  const daysEl = document.getElementById("days");
  daysEl.innerHTML = "";
  document.getElementById("monthLabel").innerText = `${y} å¹´ ${m+1} æœˆ`;

  const firstDay = new Date(y, m, 1).getDay();
  const totalDays = new Date(y, m + 1, 0).getDate();

  // å¡«è£œæœˆåˆç©ºç™½
  for(let i=0; i<firstDay; i++) {
    const empty = document.createElement("div");
    daysEl.appendChild(empty);
  }

  // æ¸²æŸ“æ—¥æœŸ
  for(let d=1; d<=totalDays; d++){
    const cell = document.createElement("div");
    cell.className = "day-cell";
    
    // é™½æ›†æ•¸å­—
    const solarSpan = document.createElement("span");
    solarSpan.className = "solar-date";
    solarSpan.innerText = d;
    
    // è¨ˆç®—è¾²æ›† (ä½¿ç”¨ solarLunar åº«)
    const lunarInfo = solarLunar.solar2lunar(y, m + 1, d);
    const lunarSpan = document.createElement("span");
    lunarSpan.className = "lunar-date";
    
    // è¾²æ›†é¡¯ç¤ºé‚è¼¯ï¼šå¦‚æœæ˜¯åˆä¸€é¡¯ç¤ºæœˆä»½ï¼Œå¦å‰‡é¡¯ç¤ºæ—¥æœŸæˆ–ç¯€æ°£
    let lunarText = lunarInfo.dayCn; 
    if(lunarInfo.dayCn === 'åˆä¸€') lunarText = lunarInfo.monthCn;
    if(lunarInfo.term) lunarText = lunarInfo.term; // å„ªå…ˆé¡¯ç¤ºç¯€æ°£ (å¦‚å†¬è‡³ã€æ¸…æ˜)
    lunarSpan.innerText = lunarText;

    const dayOfWeek = new Date(y, m, d).getDay();
    if(dayOfWeek === 0 || dayOfWeek === 6) cell.classList.add("weekend");
    if(holidays[`${m+1}-${d}`]) cell.classList.add("holiday");

    cell.appendChild(solarSpan);
    cell.appendChild(lunarSpan);
    daysEl.appendChild(cell);
  }
}

// åˆå§‹åŒ–
render();

// åˆ‡æ›æœˆä»½
document.getElementById('prev').onclick = () => { date.setMonth(date.getMonth()-1); render(); };
document.getElementById('next').onclick = () => { date.setMonth(date.getMonth()+1); render(); };

// ç›¸ç‰‡ä¸Šå‚³èˆ‡æŒä¹…åŒ–
photoInput.onchange = () => {
  const file = photoInput.files[0];
  if(!file) return;
  const r = new FileReader();
  r.onload = e => {
    photoArea.style.backgroundImage = `url(${e.target.result})`;
    try { localStorage.setItem("wallpaper_photo", e.target.result); } catch(err) { console.warn("åœ–ç‰‡å¤ªå¤§ï¼Œç„¡æ³•å­˜å…¥æœ¬åœ°æš«å­˜"); }
  };
  r.readAsDataURL(file);
};

const savedPhoto = localStorage.getItem("wallpaper_photo");
if(savedPhoto) photoArea.style.backgroundImage = `url(${savedPhoto})`;

// æ ¸å¿ƒåŠŸèƒ½ï¼šæˆªåœ–ä¸¦å½ˆå‡ºé•·æŒ‰é¸å–®
saveImage.onclick = async () => {
  saveImage.innerText = "æ­£åœ¨è™•ç†ä¸­...";
  const calendar = document.getElementById("calendar");
  
  // é€²å…¥æˆªåœ–æ¨¡å¼
  calendar.classList.add("hide-ui");
  
  try {
    const canvas = await html2canvas(calendar, {
      useCORS: true,
      scale: 3, // æé«˜åˆ° 3 å€ï¼Œç¢ºä¿åšæˆæ¡Œå¸ƒä¸æœƒæœ‰é‹¸é½’
      backgroundColor: "#000",
      logging: false
    });

    const imgData = canvas.toDataURL("image/png");
    document.getElementById("resultImage").src = imgData;
    document.getElementById("resultMask").style.display = "flex";
  } catch (err) {
    alert("ç³»çµ±å¿™ç¢Œä¸­ï¼Œè«‹ç¨å¾Œå†è©¦æˆ–ä½¿ç”¨æ‰‹æ©Ÿå…§å»ºæˆªåœ–");
    console.error(err);
  } finally {
    calendar.classList.remove("hide-ui");
    saveImage.innerText = "ğŸ“¸ ç”Ÿæˆæ‰‹æ©Ÿå„²å­˜åœ–ç‰‡";
  }
};
</script>

</body>
</html>
