<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>æˆ‘çš„å¿ƒæƒ…æ¡Œå¸ƒæœˆæ›†</title>

<style>
:root { --photo-height: 360px; }
body { margin: 0; background: #f3c6c6; font-family: -apple-system, BlinkMacSystemFont, "PingFang TC"; display: flex; flex-direction: column; align-items: center; padding: 16px; }

.calendar { width: 100%; max-width: 380px; background: #000; border-radius: 26px; overflow: hidden; color: #fff; }

/* ç…§ç‰‡å€åŸŸ */
.photo { height: var(--photo-height); background: #111 center / cover no-repeat; position: relative; cursor: pointer; }
.photo input { position: absolute; inset: 0; opacity: 0; z-index: 2; }
.photoHint { position: absolute; bottom: 10px; right: 12px; font-size: 12px; background: rgba(0,0,0,0.6); padding: 4px 8px; border-radius: 8px; pointer-events: none; }

.greeting { text-align: center; padding: 10px; font-size: 15px; background: #7f3fbf; min-height: 1.5em; }
.greeting[contenteditable] { outline: none; }

.monthNav { display: flex; justify-content: space-between; align-items: center; padding: 10px 16px; }
.monthNav button { font-size: 20px; padding: 6px 16px; border-radius: 12px; border: none; background: #ffd966; color: #000; }
#monthLabel { font-size: 18px; font-weight: bold; }

.weekdays, .days { display: grid; grid-template-columns: repeat(7, 1fr); text-align: center; }
.weekdays div { opacity: 0.8; padding-bottom: 6px; }
.days { position: relative; padding-bottom: 12px; min-height: 200px; }
.days::before { content: ""; position: absolute; inset: 0; background: url("horse.jpg") center / contain no-repeat; opacity: 0.31; pointer-events: none; }
.days div { position: relative; padding: 10px 0; border-radius: 10px; z-index: 1; }
.weekend { color: #ff4d4f; font-weight: bold; }
.holiday { background: #6bc1ff; color: #000; font-weight: bold; }

.btn { margin: 20px 0; padding: 12px 40px; border-radius: 14px; background: #ffd966; color: #000; text-align: center; font-weight: bold; cursor: pointer; width: 80%; max-width: 300px; }

/* æˆªåœ–é®ç½©å±¤ï¼šè®“åœ–ç‰‡ç”¢ç”Ÿå¾Œæµ®ç¾å‡ºä¾†çµ¦ä½¿ç”¨è€…é•·æŒ‰ */
#resultMask {
  position: fixed; top: 0; left: 0; width: 100%; height: 100%;
  background: rgba(0,0,0,0.9); display: none; flex-direction: column;
  align-items: center; justify-content: center; z-index: 999;
}
#resultImage { max-width: 90%; max-height: 80%; border-radius: 10px; box-shadow: 0 0 20px rgba(255,255,255,0.2); }
#resultMask p { color: white; margin-top: 15px; font-size: 14px; }

/* éš±è— UI é¡åˆ¥ */
.hide-ui .btn, .hide-ui .photoHint, .hide-ui .monthNav button { display: none !important; }
</style>
</head>

<body>

<div class="calendar" id="calendar">
  <div class="photo" id="photoArea">
    <input type="file" id="photoInput" accept="image/*">
    <span class="photoHint">é»æ“Šæ›´æ›ç…§ç‰‡</span>
  </div>
  <div class="greeting" contenteditable="true">é€™è£¡å¯ä»¥è¡¨é”æ‚¨çš„å¿ƒæƒ…ğŸ˜Š</div>
  <div class="monthNav">
    <button id="prev">â—€</button>
    <div id="monthLabel"></div>
    <button id="next">â–¶</button>
  </div>
  <div class="weekdays">
    <div>æ—¥</div><div>ä¸€</div><div>äºŒ</div><div>ä¸‰</div><div>å››</div><div>äº”</div><div>å…­</div>
  </div>
  <div class="days" id="days"></div>
</div>

<div class="btn" id="saveImage">ğŸ“· ç”Ÿæˆå„²å­˜åœ–ç‰‡</div>

<div id="resultMask">
  <img id="resultImage" src="" alt="ç”Ÿæˆçš„æœˆæ›†">
  <p>â–² é•·æŒ‰åœ–ç‰‡å³å¯å„²å­˜åˆ°æ‰‹æ©Ÿ â–²</p>
  <div class="btn" style="background: #aaa;" onclick="document.getElementById('resultMask').style.display='none'">è¿”å›ä¿®æ”¹</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script>
let date = new Date();
const holidays = {"1-1":"å…ƒæ—¦","2-28":"å’Œå¹³ç´€å¿µæ—¥","4-4":"å…’ç«¥ç¯€","4-5":"æ¸…æ˜ç¯€","10-10":"åœ‹æ…¶æ—¥"};

function render() {
  const y = date.getFullYear();
  const m = date.getMonth();
  const daysEl = document.getElementById("days");
  daysEl.innerHTML = "";
  document.getElementById("monthLabel").innerText = `${y} å¹´ ${m+1} æœˆ`;
  const first = new Date(y,m,1).getDay();
  const total = new Date(y,m+1,0).getDate();
  for(let i=0;i<first;i++) daysEl.innerHTML += "<div></div>";
  for(let d=1; d<=total; d++){
    const div = document.createElement("div");
    div.innerText = d;
    const w = new Date(y,m,d).getDay();
    if(w===0 || w===6) div.classList.add("weekend");
    if(holidays[`${m+1}-${d}`]) div.classList.add("holiday");
    daysEl.appendChild(div);
  }
}
render();

document.getElementById('prev').onclick = ()=>{ date.setMonth(date.getMonth()-1); render(); };
document.getElementById('next').onclick = ()=>{ date.setMonth(date.getMonth()+1); render(); };

photoInput.onchange = () => {
  const file = photoInput.files[0];
  if(!file) return;
  const r = new FileReader();
  r.onload = e => {
    photoArea.style.backgroundImage = `url(${e.target.result})`;
    try { localStorage.setItem("photo", e.target.result); } catch(e) { console.log("åœ–ç‰‡å¤ªå¤§ï¼Œç„¡æ³•å­˜å…¥ localStorage"); }
  };
  r.readAsDataURL(file);
};

const saved = localStorage.getItem("photo");
if(saved) photoArea.style.backgroundImage = `url(${saved})`;

saveImage.onclick = async () => {
  // é¡¯ç¤ºè™•ç†ä¸­æç¤º (é¸é…)
  saveImage.innerText = "è™•ç†ä¸­...";
  
  const calendar = document.getElementById("calendar");
  
  // 1ï¸âƒ£ æš«æ™‚éš±è—ä¸å¿…è¦çš„ UI
  calendar.classList.add("hide-ui");
  
  // 2ï¸âƒ£ åŸ·è¡Œæˆªåœ– (ä½¿ç”¨ scale æé«˜æ¸…æ™°åº¦)
  try {
    const canvas = await html2canvas(calendar, {
      useCORS: true, 
      scale: 2, // æé«˜å…©å€è§£æåº¦ï¼Œæ¡Œå¸ƒæ‰ä¸æœƒç³Š
      backgroundColor: "#000"
    });

    // 3ï¸âƒ£ è½‰æˆ Base64 ä¸¦é¡¯ç¤ºåœ¨é®ç½©å±¤
    const imgData = canvas.toDataURL("image/png");
    document.getElementById("resultImage").src = imgData;
    document.getElementById("resultMask").style.display = "flex";
  } catch (err) {
    alert("æˆªåœ–å¤±æ•—ï¼Œè«‹æ›´æ›ç€è¦½å™¨å˜—è©¦");
  } finally {
    calendar.classList.remove("hide-ui");
    saveImage.innerText = "ğŸ“· ç”Ÿæˆå„²å­˜åœ–ç‰‡";
  }
};
</script>

</body>
</html>
